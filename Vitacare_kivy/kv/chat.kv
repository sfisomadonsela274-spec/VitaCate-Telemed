#:import dp kivy.metrics.dp
#:import MDTopAppBar kivymd.uix.toolbar.MDTopAppBar
#:import MDRectangleFlatButton kivymd.uix.button.MDRectangleFlatButton
#:import MDTextField kivymd.uix.textfield.MDTextField
#:import MDFillRoundFlatButton kivymd.uix.button.MDFillRoundFlatButton
#:import MDRaisedButton kivymd.uix.button.MDRaisedButton

<BaseChatScreen>:
    name: root.name
    
    # Background
    canvas.before:
        Color:
            rgba: 0.95, 0.95, 0.98, 1  # Light gray background
        Rectangle:
            pos: self.pos
            size: self.size

    BoxLayout:
        orientation: 'vertical'
        padding: [dp(8), dp(8), dp(8), dp(8)]
        spacing: dp(8)

        # Header
        MDTopAppBar:
            title: root.header_title
            elevation: 0
            md_bg_color: 0.1, 0.5, 0.8, 1
            specific_text_color: 1, 1, 1, 1
            left_action_items: [['arrow-left', lambda x: root.navigate_back()]]

        MDLabel:
            text: root.partner_display_text
            theme_text_color: "Secondary"
            halign: "center"
            font_style: "Body2"
            size_hint_y: None
            height: self.texture_size[1] if self.text else 0
            padding: [dp(8), dp(4)]

        # Main Chat Area
        BoxLayout:
            orientation: 'vertical'
            spacing: dp(8)
            padding: [dp(8), 0, dp(8), 0]

            # Messages Container
            ScrollView:
                id: scroll_view
                bar_width: dp(4)
                bar_color: 0.1, 0.5, 0.8, 0.3
                bar_inactive_color: 0.1, 0.5, 0.8, 0.1
                effect_cls: "ScrollEffect"
                scroll_timeout: 100
                scroll_distance: 10

                BoxLayout:
                    id: messages_container
                    orientation: 'vertical'
                    size_hint_y: None
                    height: self.minimum_height
                    spacing: dp(8)
                    padding: [dp(8), dp(8)]

        # Input Area
        BoxLayout:
            size_hint_y: None
            height: dp(60)
            padding: [dp(8), dp(4), dp(8), dp(8)]
            spacing: dp(8)
            canvas.before:
                Color:
                    rgba: 1, 1, 1, 1
                Rectangle:
                    pos: self.pos
                    size: self.size

            TextInput:
                id: message_input
                hint_text: "Type your message..."
                multiline: True
                background_color: 1, 1, 1, 1
                foreground_color: 0.1, 0.1, 0.1, 1
                hint_text_color: 0.7, 0.7, 0.7, 1
                padding: [dp(12), dp(8), dp(12), dp(8)]
                size_hint_x: 0.85
                on_text_validate: root.send_message()
                on_focus: self.cursor = (0, 0) if not self.text else (len(self.text), 0)

            MDRaisedButton:
                id: send_button
                text: "SEND"
                size_hint_x: 0.25
                size_hint_y: None
                height: dp(48)
                md_bg_color: 0.1, 0.5, 0.8, 1
                theme_text_color: "Custom"
                text_color: 1, 1, 1, 1
                font_size: '14sp'
                elevation: 0
                on_release: root.send_message()

        # Status Bar
        BoxLayout:
            size_hint_y: None
            height: dp(20)
            padding: [dp(8), 0]
            
            Label:
                id: status_label
                text: ""
                color: 0.5, 0.5, 0.5, 1
                font_size: '12sp'
                halign: 'center'