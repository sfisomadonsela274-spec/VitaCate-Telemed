<MessageBubble>:
    size_hint: 1, None
    padding: [dp(12), dp(4), dp(12), dp(4)]
    height: anchor_layout.height + self.padding[1] + self.padding[3]

    AnchorLayout:
        id: anchor_layout
        size_hint: 1, None
        height: bubble_box.height
        anchor_x: 'right' if root.is_me else 'left'

        BoxLayout:
            id: bubble_box
            orientation: 'vertical'
            size_hint: None, None
            width: min(dp(320), root.width * 0.8)
            height: self.minimum_height
            padding: [dp(14), dp(10), dp(14), dp(10)]
            spacing: dp(6)
            canvas.before:
                Color:
                    rgba: (0.1, 0.5, 0.8, 1) if root.is_me else (0.92, 0.92, 0.96, 1)
                RoundedRectangle:
                    pos: self.pos
                    size: self.size
                    radius: [dp(18), dp(18), dp(6), dp(18)] if root.is_me else [dp(18), dp(18), dp(18), dp(6)]

            Label:
                id: lbl_sender
                text: root.sender if not root.is_me and root.sender else ''
                size_hint_y: None
                height: self.texture_size[1] if self.text else 0
                font_size: '12sp'
                bold: True
                color: (0.1, 0.5, 0.8, 1)
                text_size: (self.width, None)
                halign: 'left'
                valign: 'middle'
                markup: True

            Label:
                id: lbl_message
                text: root.message
                size_hint_y: None
                text_size: (self.width - dp(12), None)
                height: self.texture_size[1]
                font_size: '14sp'
                color: (1, 1, 1, 1) if root.is_me else (0.1, 0.1, 0.1, 1)
                halign: 'right' if root.is_me else 'left'
                valign: 'middle'
                markup: True

            Label:
                id: lbl_time
                text: root.time
                size_hint_y: None
                height: self.texture_size[1]
                font_size: '11sp'
                color: (0.85, 0.85, 0.85, 1) if root.is_me else (0.5, 0.5, 0.5, 1)
                text_size: (self.width, None)
                halign: 'right'
                valign: 'middle'
